---
import { getLangFromUrl } from "../i18n/utils.ts";
import Layout from "../layouts/Layout.astro";
import { desc, eq } from 'drizzle-orm';
import { db } from 'astro:db';
import { Posts, Tags, Images, PostImages, PostTags } from 'astro:db';

const lang = getLangFromUrl(Astro.url);

export const prerender = false;

interface Post {
  posts: {
    id: number;
    slug: string;
    title: string;
    description: string;
    author: string;
    publish_date: string;
    locale: string;
  };
  tags: {
    id: number;
    name: string;
  } | null;
  images: {
    id: number;
    url: string;
    alt: string;
  } | null;
}

const posts = await db.select({
  posts: Posts,
  tags: Tags,
  images: Images,
})
.from(Posts)
.leftJoin(PostTags, eq(PostTags.postId, Posts.id))
.leftJoin(Tags, eq(PostTags.tagId, Tags.id))
.leftJoin(PostImages, eq(PostImages.postId, Posts.id))
.leftJoin(Images, eq(PostImages.imageId, Images.id))
.where(eq(Posts.locale, lang))
.orderBy(desc(Posts.publish_date))
.all();

const postsMap = new Map();

posts.forEach((post: Post) => {
  if (!postsMap.has(post.posts.id)) {
    postsMap.set(post.posts.id, {
      id: post.posts.id,
      slug: `/blog/${post.posts.slug}`,
      url: `/blog/${post.posts.slug}`,
      frontmatter: {
        title: post.posts.title,
        description: post.posts.description,
      },
      tags: [],
      image: {
        url: post.images?.url,
        alt: post.images?.alt,
      },
    });
  }
  const postEntry = postsMap.get(post.posts.id);
  if (post.tags?.name) {
    postEntry.tags.push(post.tags.name);
  }
});

const postsArray = Array.from(postsMap.values());
const blogBaseUrl = "https://www.ignathedev.com";
const blogUrl = `${blogBaseUrl}/blog`;
---

<Layout
    title="Blog Desarrollo Web | Tutoriales PHP, Laravel, Vue.js | Ignacio Amat"
    description="Artículos y tutoriales sobre desarrollo web, PHP, Laravel, Vue.js y JavaScript. Aprende buenas prácticas con un desarrollador full stack en Barcelona."
    pageType="website">
    <main class="min-h-screen">
        <div class="max-w-6xl mx-auto px-6 py-12">
          <!-- Hero Section -->
          <div class="text-center mb-16">
            <nav class="mb-6" aria-label="Breadcrumb">
              <a href="/" class="text-blue-600 dark:text-blue-400 hover:underline">Inicio</a>
              <span class="mx-2 text-gray-500">/</span>
              <span class="text-gray-600 dark:text-gray-400">Blog</span>
            </nav>
            <span class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-sm font-medium mb-6">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
              </svg>
              Blog Técnico
            </span>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-6">
                Blog de Desarrollo Web — <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Tutoriales PHP, Laravel y Vue.js</span>
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto leading-relaxed">
              Artículos, tutoriales y novedades sobre desarrollo web, PHP, Laravel, Vue.js y tecnologías modernas.
            </p>
          </div>
        <ul class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {
             postsArray.map((post) => {
               const moreTagsCount = post.tags.length - 3;
               return (
                 <article class="group bg-white dark:bg-gray-800 rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 border border-gray-200 dark:border-gray-700 hover:border-blue-300 dark:hover:border-blue-600 flex flex-col">
                     <a href={post.slug} class="block overflow-hidden aspect-video">
                         <img class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                              width={400}
                              height={225} 
                              src={post.image.url} 
                              alt={post.image.alt}
                              loading="lazy" />
                     </a>
                     <div class="p-6 flex flex-col flex-grow">
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            {post.tags.slice(0, 3).map((tag: string) => (
                            <span class="px-2.5 py-1 text-xs font-medium text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/50 rounded-full">
                                {tag}
                            </span>
                            ))}
                            {moreTagsCount > 0 && (
                            <span class="px-2.5 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-full">
                                +{moreTagsCount}
                            </span>
                            )}
                        </div>
                        
                        <!-- Title -->
                        <a href={post.url} class="block mb-3">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-2">
                                {post.frontmatter.title}
                            </h2>
                        </a>
                        
                        <!-- Description -->
                        <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed line-clamp-3 mb-4 flex-grow">
                            {post.frontmatter.description}
                        </p>
                        
                        <!-- Read More Link -->
                        <a href={post.url}
                            class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors group/link">
                            Leer artículo
                            <svg class="w-4 h-4 transition-transform group-hover/link:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </a>
                     </div>
                 </article>
               );
             })
            }
        </ul>
        
        <!-- Empty State -->
        {postsArray.length === 0 && (
          <div class="text-center py-16">
            <svg class="w-16 h-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No hay artículos todavía</h3>
            <p class="text-gray-600 dark:text-gray-400">Pronto publicaré contenido nuevo. ¡Vuelve pronto!</p>
          </div>
        )}
    </div>
    </main>
</Layout>

<!-- CollectionPage schema for blog listing SEO -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Blog de Desarrollo Web - Ignacio Amat",
  "description": "Artículos y tutoriales sobre desarrollo web, PHP, Laravel, Vue.js y JavaScript",
  "url": blogUrl,
  "inLanguage": "es-ES",
  "isPartOf": { "@id": "https://www.ignathedev.com/#website" },
  "mainEntity": {
    "@type": "ItemList",
    "itemListElement": postsArray.map((post, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "url": `${blogBaseUrl}${post.slug}`,
      "name": post.frontmatter.title,
    })),
  },
})} />

<style>
    .tags-wrapper {
        position: relative;
        max-width: 100%;
        overflow: hidden;
    }
</style>

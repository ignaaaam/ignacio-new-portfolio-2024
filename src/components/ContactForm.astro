---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { actions } from 'astro:actions';
import { Toast } from './Toast.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get form result if coming from a form submission
const result = await Astro.getActionResult();
---

<div class="w-full max-w-4xl mx-auto">
  {result && (
    <Toast 
      type={result.error ? 'error' : 'success'}
      message={result.error ? 
        (result.error.message || 'Error sending message. Please try again.') : 
        'Message sent successfully! I will contact you soon.'}
      client:load
    />
  )}

  <form 
    method="POST"
    action={actions.send}
    class="space-y-6 backdrop-blur-sm bg-white/5 p-8 rounded-xl border border-white/10 shadow-2xl transition-all duration-300"
  >
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
      <div>
        <label for="name" class="block text-sm font-medium text-white">
          {lang === 'es' ? 'Nombre' : 'Name'}
        </label>
        <input
          type="text"
          name="name"
          id="name"
          required
          class="mt-1 block w-full rounded-lg border border-gray-700 bg-gray-900/50 px-4 py-2 text-white shadow-sm backdrop-blur-sm focus:border-yellow-200 focus:ring-2 focus:ring-yellow-200/50"
          placeholder={lang === 'es' ? 'Tu nombre' : 'Your name'}
        />
      </div>
      <div>
        <label for="email" class="block text-sm font-medium text-white">Email</label>
        <input
          type="email"
          name="email"
          id="email"
          required
          class="mt-1 block w-full rounded-lg border border-gray-700 bg-gray-900/50 px-4 py-2 text-white shadow-sm backdrop-blur-sm focus:border-yellow-200 focus:ring-2 focus:ring-yellow-200/50"
          placeholder={lang === 'es' ? 'tu@email.com' : 'your@email.com'}
        />
      </div>
    </div>

    <div>
      <label for="project_type" class="block text-sm font-medium text-white">
        {lang === 'es' ? 'Tipo de proyecto' : 'Project type'}
      </label>
      <select
        id="project_type"
        name="project_type"
        required
        class="mt-1 block w-full rounded-lg border border-gray-700 bg-gray-900/50 px-4 py-2 text-white shadow-sm backdrop-blur-sm focus:border-yellow-200 focus:ring-2 focus:ring-yellow-200/50"
      >
        <option value="">{lang === 'es' ? 'Selecciona una opción' : 'Select an option'}</option>
        <option value="landing">Landing Page</option>
        <option value="ecommerce">E-commerce</option>
        <option value="web-app">{lang === 'es' ? 'Aplicación Web' : 'Web Application'}</option>
        <option value="other">{lang === 'es' ? 'Otro' : 'Other'}</option>
      </select>
    </div>

    <div>
      <label for="budget" class="block text-sm font-medium text-white">
        {lang === 'es' ? 'Presupuesto aproximado' : 'Approximate budget'}
      </label>
      <select
        id="budget"
        name="budget"
        required
        class="mt-1 block w-full rounded-lg border border-gray-700 bg-gray-900/50 px-4 py-2 text-white shadow-sm backdrop-blur-sm focus:border-yellow-200 focus:ring-2 focus:ring-yellow-200/50"
      >
        <option value="">{lang === 'es' ? 'Selecciona un rango' : 'Select a range'}</option>
        <option value="500-1000">500€ - 1.000€</option>
        <option value="1000-2500">1.000€ - 2.500€</option>
        <option value="2500-5000">2.500€ - 5.000€</option>
        <option value="5000+">{lang === 'es' ? 'Más de 5.000€' : 'More than 5.000€'}</option>
      </select>
    </div>

    <div>
      <label for="message" class="block text-sm font-medium text-white">
        {lang === 'es' ? 'Mensaje' : 'Message'}
      </label>
      <div class="relative">
        <textarea
          id="message"
          name="message"
          rows="4"
          required
          maxlength="500"
          class="mt-1 block w-full rounded-lg border border-gray-700 bg-gray-900/50 px-4 py-2 text-white shadow-sm backdrop-blur-sm focus:border-yellow-200 focus:ring-2 focus:ring-yellow-200/50 transition-colors duration-200"
          placeholder={lang === 'es' ? 'Cuéntame sobre tu proyecto...' : 'Tell me about your project...'}
        ></textarea>
        <div class="absolute bottom-2 right-2 text-xs text-gray-400">
          <span id="charCount">0</span>/500
        </div>
      </div>
    </div>

    <div class="flex justify-center">
      <button
        type="submit"
        class="blob-white border border-black bg-white text-black p-5 rounded-full uppercase font-black text-base relative shadow-md shadow-white/20 transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span class="button-text">{lang === 'es' ? 'Enviar mensaje' : 'Send message'}</span>
      </button>
    </div>
  </form>
</div>

<style>
  .form-success {
    animation: formSuccess 0.5s ease-in-out;
  }

  @keyframes formSuccess {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }

  input:invalid:not(:placeholder-shown),
  select:invalid:not(:placeholder-shown),
  textarea:invalid:not(:placeholder-shown) {
    border-color: rgb(239, 68, 68);
  }

  input:valid:not(:placeholder-shown),
  select:valid:not(:placeholder-shown),
  textarea:valid:not(:placeholder-shown) {
    border-color: rgb(34, 197, 94);
  }

  .loading {
    opacity: 0.7;
    cursor: wait;
  }

  input, select, textarea {
    transition: all 0.2s ease-in-out;
  }

  input:focus, select:focus, textarea:focus {
    transform: translateY(-1px);
  }
</style>

<script>
  const form = document.querySelector('form');
  const messageTextarea = document.getElementById('message');
  const charCount = document.getElementById('charCount');
  
  if (messageTextarea && charCount) {
    messageTextarea.addEventListener('input', () => {
      charCount.textContent = messageTextarea.value.length;
    });
  }
  
  if (form) {
    form.addEventListener('submit', (e) => {
      const submitButton = form.querySelector('button[type="submit"]');
      if (!submitButton) return;
      
      // Add loading state
      submitButton.disabled = true;
      submitButton.innerHTML = `
        <svg class="animate-spin h-5 w-5 text-black inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>${document.documentElement.lang === 'es' ? 'Enviando...' : 'Sending...'}</span>
      `;
    });
  }
</script>
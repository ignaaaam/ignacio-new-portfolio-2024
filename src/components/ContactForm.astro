---
import { getLangFromUrl } from "../i18n/utils";
import { Toast, Icon } from "webcoreui/astro";

const lang = getLangFromUrl(Astro.url);
---

<div class="w-full max-w-4xl mx-auto relative">
  <!-- iOS form styling prevention -->
  <meta
    name="format-detection"
    content="telephone=no"
  />

  <!-- Success Toast -->
  <Toast
    className="toast-success !max-w-sm"
    position="bottom-full"
    theme="success"
  >
    <Icon
      type="check"
      slot="icon"
    />
  </Toast>

  <!-- Error Toast -->
  <Toast
    className="toast-error !max-w-sm"
    position="bottom-full"
    theme="alert"
  >
    <Icon
      type="x"
      slot="icon"
    />
  </Toast>

  <form
    method="POST"
    action="/api/contact"
    id="contact-form"
    class="contact-form-container"
    style="color-scheme: light dark;"
  >
    <!-- Decorative background elements -->
    <div
      class="form-background"
      aria-hidden="true"
    >
    </div>

    <div class="form-content">
      <div class="form-grid">
        <!-- Name Field -->
        <div class="form-field">
          <label
            for="name"
            class="form-label"
          >
            {lang === "es" ? "Nombre" : "Name"}
          </label>
          <div class="input-wrapper">
            <input
              type="text"
              name="name"
              id="name"
              autocomplete="name"
              required
              minlength="2"
              class="form-input"
              placeholder={lang === "es" ? "Tu nombre…" : "Your name…"}
            />
          </div>
        </div>

        <!-- Email Field -->
        <div class="form-field">
          <label
            for="email"
            class="form-label"
          >
            Email
          </label>
          <div class="input-wrapper">
            <input
              type="email"
              name="email"
              id="email"
              autocomplete="email"
              spellcheck="false"
              required
              class="form-input"
              placeholder={lang === "es" ? "tu@email.com…" : "your@email.com…"}
            />
          </div>
        </div>
      </div>

      <!-- Project Type Field -->
      <div class="form-field">
        <label
          for="project_type"
          class="form-label"
        >
          {lang === "es" ? "Tipo de proyecto" : "Project type"}
        </label>
        <div class="input-wrapper">
          <select
            id="project_type"
            name="project_type"
            required
            class="form-select"
          >
            <option value="">{lang === "es" ? "Selecciona una opción…" : "Select an option…"}</option>
            <option value="landing">Landing Page</option>
            <option value="ecommerce">E-commerce</option>
            <option value="web-app">{lang === "es" ? "Aplicación Web" : "Web Application"}</option>
            <option value="other">{lang === "es" ? "Otro" : "Other"}</option>
          </select>
        </div>
      </div>

      <!-- Budget Field -->
      <div class="form-field">
        <label
          for="budget"
          class="form-label"
        >
          {lang === "es" ? "Presupuesto aproximado" : "Approximate budget"}
        </label>
        <div class="input-wrapper">
          <select
            id="budget"
            name="budget"
            required
            class="form-select"
          >
            <option value="">{lang === "es" ? "Selecciona un rango…" : "Select a range…"}</option>
            <option value="500-1000">500€ - 1.000€</option>
            <option value="1000-2500">1.000€ - 2.500€</option>
            <option value="2500-5000">2.500€ - 5.000€</option>
            <option value="5000+">{lang === "es" ? "Más de 5.000€" : "More than 5.000€"}</option>
          </select>
        </div>
      </div>

      <!-- Message Field -->
      <div class="form-field">
        <label
          for="message"
          class="form-label"
        >
          {lang === "es" ? "Mensaje" : "Message"}
        </label>
        <div class="textarea-wrapper">
          <textarea
            id="message"
            name="message"
            rows="5"
            required
            minlength="10"
            maxlength="500"
            class="form-textarea"
            placeholder={lang === "es" ? "Cuéntame sobre tu proyecto…" : "Tell me about your project…"}
          ></textarea>
          <div
            class="char-counter"
            aria-live="polite"
            aria-atomic="true"
          >
            <span id="charCount">0</span>/500
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button
          type="submit"
          class="submit-button"
          aria-label={lang === "es" ? "Enviar mensaje" : "Send message"}
        >
          <span class="button-content">
            <span class="button-text">{lang === "es" ? "Enviar mensaje" : "Send message"}</span>
            <svg
              class="button-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
          </span>
          <span
            class="button-loading"
            aria-hidden="true"
          >
            {lang === "es" ? "Enviando…" : "Sending…"}
          </span>
        </button>
      </div>
    </div>
  </form>
</div>

<style>
  :global(.toast-success),
  :global(.toast-error) {
    max-height: fit-content !important;
    height: auto !important;
    padding: 1rem !important;
  }

  .contact-form-container {
    position: relative;
    width: 100%;
    padding: clamp(1.5rem, 4vw, 3rem);
    background:
      linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%), radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: clamp(1rem, 2vw, 1.5rem);
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.05),
      0 10px 15px -3px rgba(0, 0, 0, 0.05),
      0 0 0 1px rgba(0, 0, 0, 0.02);
    backdrop-filter: blur(12px);
    transition:
      box-shadow 0.3s ease,
      border-color 0.3s ease,
      background-color 0.3s ease;
  }

  :global(.dark) .contact-form-container {
    background:
      linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(31, 41, 55, 0.98) 100%), radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 10px 15px -3px rgba(0, 0, 0, 0.2),
      0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  .form-background {
    position: absolute;
    inset: 0;
    border-radius: 1.5rem;
    opacity: 0;
    background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 70%);
    transition: opacity 0.5s ease;
    pointer-events: none;
  }

  .contact-form-container:focus-within .form-background {
    opacity: 1;
  }

  .form-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, 4vw, 2rem);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: clamp(1.5rem, 4vw, 2rem);
  }

  @media (min-width: 768px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(1.75rem, 4vw, 2rem);
    }
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    display: block;
    font-size: clamp(0.8125rem, 1.5vw, 0.875rem);
    font-weight: 600;
    letter-spacing: 0.01em;
    color: rgb(55, 65, 81);
    transition: color 0.2s ease;
    margin-bottom: 0;
  }

  :global(.dark) .form-label {
    color: rgb(209, 213, 219);
  }

  .input-wrapper,
  .textarea-wrapper {
    position: relative;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: clamp(1rem, 2vw, 1rem);
    line-height: 1.5;
    color: rgb(17, 24, 39);
    background-color: rgba(255, 255, 255, 0.8);
    border: 1.5px solid rgba(0, 0, 0, 0.08);
    border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
    transition:
      border-color 0.2s ease,
      background-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.2s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    font-family: inherit;
    min-height: 44px; /* Touch target size for mobile */
  }

  :global(.dark) .form-input,
  :global(.dark) .form-select,
  :global(.dark) .form-textarea {
    color: rgb(243, 244, 246);
    background-color: rgba(31, 41, 55, 0.6);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: rgb(156, 163, 175);
    opacity: 0.7;
  }

  :global(.dark) .form-input::placeholder,
  :global(.dark) .form-textarea::placeholder {
    color: rgb(107, 114, 128);
  }

  @media (hover: hover) and (pointer: fine) {
    .form-input:hover,
    .form-select:hover,
    .form-textarea:hover {
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
    }

    :global(.dark) .form-input:hover,
    :global(.dark) .form-select:hover,
    :global(.dark) .form-textarea:hover {
      border-color: rgba(96, 165, 250, 0.4);
    }
  }

  :global(.dark) .form-input:hover,
  :global(.dark) .form-select:hover,
  :global(.dark) .form-textarea:hover {
    border-color: rgba(96, 165, 250, 0.4);
  }

  .form-input:focus-visible,
  .form-select:focus-visible,
  .form-textarea:focus-visible {
    outline: none;
    border-color: rgb(59, 130, 246);
    box-shadow:
      0 0 0 3px rgba(59, 130, 246, 0.1),
      0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }

  :global(.dark) .form-input:focus-visible,
  :global(.dark) .form-select:focus-visible,
  :global(.dark) .form-textarea:focus-visible {
    border-color: rgb(96, 165, 250);
    box-shadow:
      0 0 0 3px rgba(96, 165, 250, 0.15),
      0 4px 6px -1px rgba(0, 0, 0, 0.3);
  }

  .form-select {
    padding-right: 2.75rem;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25em;
    cursor: pointer;
  }

  :global(.dark) .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  }

  :global(.dark) .form-select option {
    background-color: rgb(31, 41, 55);
    color: rgb(243, 244, 246);
  }

  .form-textarea {
    resize: none;
    min-height: clamp(100px, 20vw, 140px);
    padding-bottom: 2.5rem; /* Space for character counter */
  }

  .textarea-wrapper {
    position: relative;
  }

  .char-counter {
    position: absolute;
    bottom: clamp(0.5rem, 1.5vw, 0.75rem);
    right: clamp(0.625rem, 2vw, 0.875rem);
    font-size: clamp(0.6875rem, 1.5vw, 0.75rem);
    color: rgb(107, 114, 128);
    background: rgba(255, 255, 255, 0.95);
    padding: clamp(0.1875rem, 0.5vw, 0.25rem) clamp(0.375rem, 1vw, 0.5rem);
    border-radius: clamp(0.25rem, 0.75vw, 0.375rem);
    backdrop-filter: blur(8px);
    pointer-events: none;
    font-weight: 500;
  }

  :global(.dark) .char-counter {
    color: rgb(156, 163, 175);
    background: rgba(31, 41, 55, 0.9);
  }

  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: clamp(1.25rem, 3vw, 2rem);
  }

  .submit-button {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: clamp(0.875rem, 2vw, 1rem) clamp(2rem, 5vw, 2.5rem);
    font-size: clamp(0.9375rem, 2vw, 1rem);
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, rgb(59, 130, 246) 0%, rgb(37, 99, 235) 100%);
    border: none;
    border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
    cursor: pointer;
    overflow: hidden;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease,
      background 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    min-height: 48px; /* Touch target size for mobile */
    min-width: 120px;
  }

  :global(.dark) .submit-button {
    background: linear-gradient(135deg, rgb(59, 130, 246) 0%, rgb(37, 99, 235) 100%);
    box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
  }

  .submit-button::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgb(37, 99, 235) 0%, rgb(29, 78, 216) 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  @media (hover: hover) and (pointer: fine) {
    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow:
        0 10px 15px -3px rgba(59, 130, 246, 0.3),
        0 4px 6px -2px rgba(59, 130, 246, 0.2);
    }

    :global(.dark) .submit-button:hover:not(:disabled) {
      box-shadow:
        0 10px 15px -3px rgba(59, 130, 246, 0.4),
        0 4px 6px -2px rgba(59, 130, 246, 0.3);
    }

    .submit-button:hover:not(:disabled)::before {
      opacity: 1;
    }

    .submit-button:hover:not(:disabled) .button-icon {
      transform: translateX(4px);
    }
  }

  .submit-button:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-button:focus-visible {
    outline: none;
    box-shadow:
      0 0 0 3px rgba(59, 130, 246, 0.3),
      0 10px 15px -3px rgba(59, 130, 246, 0.3),
      0 4px 6px -2px rgba(59, 130, 246, 0.2);
  }

  .submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .button-content,
  .button-loading {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1;
  }

  .button-loading {
    display: none;
  }

  .submit-button[aria-busy="true"] .button-content {
    display: none;
  }

  .submit-button[aria-busy="true"] .button-loading {
    display: inline-flex;
  }

  .button-icon {
    width: clamp(1rem, 2.5vw, 1.25rem);
    height: clamp(1rem, 2.5vw, 1.25rem);
    transition: transform 0.3s ease;
    flex-shrink: 0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Grid adjustments for different screen sizes */
  @media (max-width: 640px) {
    .contact-form-container {
      padding: 1.5rem 1rem;
      border-radius: 1rem;
    }

    .form-content {
      gap: 1.5rem;
    }

    .form-grid {
      gap: 1.5rem;
    }

    .form-field {
      gap: 0.5rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 16px; /* Prevent zoom on iOS */
      padding: 0.75rem 1rem;
      min-height: 48px; /* Larger touch target */
    }

    .form-textarea {
      min-height: 120px;
      padding-bottom: 2.75rem;
    }

    .char-counter {
      bottom: 0.625rem;
      right: 0.75rem;
      font-size: 0.6875rem;
      padding: 0.1875rem 0.375rem;
    }

    .submit-button {
      width: 100%;
      padding: 0.875rem 1.5rem;
      min-height: 48px;
      font-size: 1rem;
    }

    .button-icon {
      width: 1.125rem;
      height: 1.125rem;
    }
  }

  /* Tablet optimizations */
  @media (min-width: 641px) and (max-width: 1024px) {
    .contact-form-container {
      padding: 2.25rem 2rem;
    }

    .form-content {
      gap: 1.75rem;
    }

    .form-grid {
      gap: 1.75rem;
    }

    .form-field {
      gap: 0.5rem;
    }

    .submit-button {
      padding: 0.9375rem 2.25rem;
    }
  }

  /* Desktop optimizations */
  @media (min-width: 1025px) {
    .contact-form-container {
      padding: 3rem;
    }

    .form-content {
      gap: 2rem;
    }

    .form-grid {
      gap: 2rem;
    }

    .form-field {
      gap: 0.625rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 0.875rem 1.125rem;
    }

    .submit-button {
      padding: 1rem 2.5rem;
    }
  }

  /* Large desktop */
  @media (min-width: 1440px) {
    .contact-form-container {
      padding: 3.5rem;
    }

    .form-content {
      gap: 2.25rem;
    }

    .form-grid {
      gap: 2.25rem;
    }
  }

  /* iOS specific fixes */
  @supports (-webkit-touch-callout: none) {
    .form-input,
    .form-select,
    .form-textarea {
      -webkit-appearance: none;
      transform: translateZ(0);
    }

    /* Prevent iOS zoom on focus */
    @media (max-width: 640px) {
      .form-input,
      .form-select,
      .form-textarea {
        font-size: 16px !important;
      }
    }
  }

  /* Touch device optimizations */
  @media (pointer: coarse) {
    .form-input,
    .form-select,
    .form-textarea {
      min-height: 48px;
    }

    .submit-button {
      min-height: 48px;
      min-width: 140px;
    }
  }
</style>

<script>
  import { toast, setDefaultTimeout } from "webcoreui";

  setDefaultTimeout(5000);
  const form = document.getElementById("contact-form");
  const submitButton = form?.querySelector(".submit-button");
  const originalButtonText = submitButton?.querySelector(".button-text")?.textContent || "";

  // Character counter for message
  const messageTextarea = document.getElementById("message");
  const charCount = document.getElementById("charCount");

  messageTextarea?.addEventListener("input", () => {
    if (charCount) {
      charCount.textContent = (messageTextarea as HTMLTextAreaElement).value.length.toString();
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!submitButton) return;

    // Set loading state
    submitButton.setAttribute("disabled", "true");
    submitButton.setAttribute("aria-busy", "true");

    const formData = new FormData(e.target as HTMLFormElement);
    console.log("Submitting form to /api/contact");

    try {
      const response = await fetch("/api/contact", {
        method: "POST",
        body: formData,
      });

      console.log("Response status:", response.status);

      let result: { success: boolean; message?: string; error?: string; title?: string };
      try {
        result = await response.json();
      } catch (jsonError) {
        console.error("Failed to parse JSON response:", jsonError);
        throw new Error("Invalid server response");
      }

      console.log("Response result:", result);

      if (result.success) {
        toast({
          element: ".toast-success",
          title: result.title,
          content: result.message,
          position: "bottom-full",
        });
        (e.target as HTMLFormElement).reset();
        if (charCount) charCount.textContent = "0";
      } else {
        toast({
          element: ".toast-error",
          title: result.title || "Error",
          content: result.error || "Failed to send message",
          position: "bottom-full",
        });
      }
    } catch (error) {
      console.error("Form submission error:", error);
      toast({
        element: ".toast-error",
        title: "Error",
        content: "Unable to process your request. Please try again later.",
        position: "bottom-full",
      });
    } finally {
      // Reset button state
      submitButton.removeAttribute("disabled");
      submitButton.removeAttribute("aria-busy");
    }
  });
</script>

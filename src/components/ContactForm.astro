---
import { getLangFromUrl } from "../i18n/utils";
import { Toast, Icon } from "webcoreui/astro";

const lang = getLangFromUrl(Astro.url);
---

<div class="w-full max-w-4xl mx-auto relative">
  <!-- Success Toast -->
  <Toast
    className="toast-success !max-w-sm"
    position="bottom-full"
    theme="success"
  >
    <Icon
      type="check"
      slot="icon"
    />
  </Toast>

  <!-- Error Toast -->
  <Toast
    className="toast-error !max-w-sm"
    position="bottom-full"
    theme="alert"
  >
  </Toast>

  <form
    method="POST"
    action="/api/contact"
    id="contact-form"
    data-lang={lang}
    class="contact-form-container"
    style="color-scheme: light dark;"
  >
    <input type="hidden" name="lang" value={lang} />
    <input type="hidden" name="form_started_at" id="form_started_at" value="" />
    <input
      type="text"
      name="website"
      tabindex="-1"
      autocomplete="off"
      class="honeypot-input"
      aria-hidden="true"
    />

    <!-- Decorative background elements -->
    <div
      class="form-background"
      aria-hidden="true"
    >
    </div>

    <div class="form-content">
      <div class="form-intro">
        <p class="form-intro-title">{lang === "es" ? "Cuéntame sobre tu equipo" : "Tell me about your team"}</p>
        <p class="form-intro-description">
          {lang === "es"
            ? "Estoy abierto a posiciones full-time remotas, contratos a largo plazo y colaboraciones con equipos de desarrollo internacionales."
            : "I'm open to full-time remote positions, long-term contracts, and collaborations with international development teams."}
        </p>
      </div>

      <div class="form-grid">
        <!-- Name Field -->
        <div class="form-field">
          <label
            for="name"
            class="form-label"
          >
            {lang === "es" ? "Nombre" : "Name"}
          </label>
          <div class="input-wrapper">
            <input
              type="text"
              name="name"
              id="name"
              autocomplete="name"
              required
              minlength="2"
              class="form-input"
              placeholder={lang === "es" ? "Tu nombre…" : "Your name…"}
            />
          </div>
        </div>

        <!-- Email Field -->
        <div class="form-field">
          <label
            for="email"
            class="form-label"
          >
            Email
          </label>
          <div class="input-wrapper">
            <input
              type="email"
              name="email"
              id="email"
              autocomplete="email"
              spellcheck="false"
              required
              class="form-input"
              placeholder={lang === "es" ? "tu@email.com…" : "your@email.com…"}
            />
          </div>
        </div>

        <div class="form-field">
          <label for="company" class="form-label">
            {lang === "es" ? "Empresa (opcional)" : "Company (optional)"}
          </label>
          <div class="input-wrapper">
            <input
              type="text"
              name="company"
              id="company"
              autocomplete="organization"
              class="form-input"
              placeholder={lang === "es" ? "Nombre de empresa" : "Company name"}
            />
          </div>
        </div>
      </div>

      <!-- Project Type Field -->
      <div class="form-field">
        <label
          for="project_type"
          class="form-label"
        >
          {lang === "es" ? "Tipo de oportunidad" : "Opportunity type"}
        </label>
        <div class="input-wrapper">
          <select
            id="project_type"
            name="project_type"
            required
            class="form-select"
          >
            <option value="">{lang === "es" ? "Selecciona una opción…" : "Select an option…"}</option>
            <option value="full-time">{lang === "es" ? "Posición full-time remota" : "Full-time remote position"}</option>
            <option value="long-term-contract">{lang === "es" ? "Contrato a largo plazo" : "Long-term contract"}</option>
            <option value="team-augmentation">{lang === "es" ? "Refuerzo de equipo (team augmentation)" : "Team augmentation"}</option>
            <option value="consultation">{lang === "es" ? "Consultoría técnica" : "Technical consultation"}</option>
            <option value="other">{lang === "es" ? "Otro" : "Other"}</option>
          </select>
        </div>
      </div>

      <div class="form-field">
        <label
          for="timeline"
          class="form-label"
        >
          {lang === "es" ? "Fecha de incorporación estimada" : "Expected start date"}
        </label>
        <div class="input-wrapper">
          <select
            id="timeline"
            name="timeline"
            required
            class="form-select"
          >
            <option value="">{lang === "es" ? "Selecciona una opción…" : "Select an option…"}</option>
            <option value="immediately">{lang === "es" ? "Inmediata" : "Immediately"}</option>
            <option value="2-4-weeks">{lang === "es" ? "En 2-4 semanas" : "Within 2-4 weeks"}</option>
            <option value="1-3-months">{lang === "es" ? "En 1-3 meses" : "Within 1-3 months"}</option>
            <option value="flexible">{lang === "es" ? "Flexible" : "Flexible"}</option>
          </select>
        </div>
      </div>

      <!-- Budget Field -->
      <div class="form-field">
        <label
          for="budget"
          class="form-label"
        >
          {lang === "es" ? "Rango salarial (opcional)" : "Salary range (optional)"}
        </label>
        <div class="input-wrapper">
          <select
            id="budget"
            name="budget"
            class="form-select"
          >
            <option value="">{lang === "es" ? "Selecciona un rango…" : "Select a range…"}</option>
            <option value="salary-30-45k">{lang === "es" ? "30k€ - 45k€ bruto/año" : "30k€ - 45k€ gross/year"}</option>
            <option value="salary-45-65k">{lang === "es" ? "45k€ - 65k€ bruto/año" : "45k€ - 65k€ gross/year"}</option>
            <option value="salary-65k+">{lang === "es" ? "+65k€ bruto/año" : "65k€+ gross/year"}</option>
            <option value="prefer-not">{lang === "es" ? "Prefiero no indicarlo" : "Prefer not to say"}</option>
          </select>
        </div>
      </div>

      <!-- Message Field -->
      <div class="form-field">
        <label
          for="message"
          class="form-label"
        >
          {lang === "es" ? "Mensaje" : "Message"}
        </label>
        <div class="textarea-wrapper">
          <textarea
            id="message"
            name="message"
            rows="5"
            required
            minlength="10"
            maxlength="500"
            class="form-textarea"
            placeholder={lang === "es" ? "Cuéntame sobre tu proyecto…" : "Tell me about your project…"}
          ></textarea>
          <div
            class="char-counter"
            aria-live="polite"
            aria-atomic="true"
          >
            <span id="charCount">0</span>/500
          </div>
        </div>
      </div>

      <label class="consent-row">
        <input type="checkbox" name="consent" required />
        <span>
          {lang === "es"
            ? "Acepto que uses estos datos para responder a mi solicitud."
            : "I agree to the use of this data to reply to my request."}
        </span>
      </label>

      <!-- Submit Button -->
      <div class="form-actions">
        <button
          type="submit"
          class="submit-button"
          aria-label={lang === "es" ? "Enviar mensaje" : "Send message"}
        >
          <span class="button-content">
            <span class="button-text">{lang === "es" ? "Enviar mensaje" : "Send message"}</span>
            <svg
              class="button-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
          </span>
          <span
            class="button-loading"
            aria-hidden="true"
          >
            {lang === "es" ? "Enviando…" : "Sending…"}
          </span>
        </button>
      </div>
    </div>
  </form>
</div>

<style>
  :global(.toast-success),
  :global(.toast-error) {
    max-height: fit-content !important;
    height: auto !important;
    padding: 1rem !important;
  }

  .contact-form-container {
    position: relative;
    width: 100%;
    padding: clamp(1.5rem, 4vw, 3rem);
    background:
      linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%), radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: clamp(1rem, 2vw, 1.5rem);
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.05),
      0 10px 15px -3px rgba(0, 0, 0, 0.05),
      0 0 0 1px rgba(0, 0, 0, 0.02);
    backdrop-filter: blur(12px);
    transition:
      box-shadow 0.3s ease,
      border-color 0.3s ease,
      background-color 0.3s ease;
  }

  :global(.dark) .contact-form-container {
    background:
      linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(31, 41, 55, 0.98) 100%), radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.3),
      0 10px 15px -3px rgba(0, 0, 0, 0.2),
      0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  .form-background {
    position: absolute;
    inset: 0;
    border-radius: 1.5rem;
    opacity: 0;
    background: radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.1), transparent 70%);
    transition: opacity 0.5s ease;
    pointer-events: none;
  }

  .contact-form-container:focus-within .form-background {
    opacity: 1;
  }

  .form-content {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, 4vw, 2rem);
  }

  .honeypot-input {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
  }

  .form-intro {
    display: grid;
    gap: 0.35rem;
  }

  .form-intro-title {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 700;
    color: rgb(17, 24, 39);
  }

  .form-intro-description {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.5;
    color: rgb(75, 85, 99);
  }

  :global(.dark) .form-intro-title {
    color: rgb(243, 244, 246);
  }

  :global(.dark) .form-intro-description {
    color: rgb(156, 163, 175);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: clamp(1.5rem, 4vw, 2rem);
  }

  @media (min-width: 768px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(1.75rem, 4vw, 2rem);
    }
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-label {
    display: block;
    font-size: clamp(0.8125rem, 1.5vw, 0.875rem);
    font-weight: 600;
    letter-spacing: 0.01em;
    color: rgb(55, 65, 81);
    transition: color 0.2s ease;
    margin-bottom: 0;
  }

  :global(.dark) .form-label {
    color: rgb(209, 213, 219);
  }

  .input-wrapper,
  .textarea-wrapper {
    position: relative;
  }

  .form-input,
  .form-select,
  .form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: clamp(1rem, 2vw, 1rem);
    line-height: 1.5;
    color: rgb(17, 24, 39);
    background-color: rgba(255, 255, 255, 0.8);
    border: 1.5px solid rgba(0, 0, 0, 0.08);
    border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
    transition:
      border-color 0.2s ease,
      background-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.2s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    font-family: inherit;
    min-height: 44px; /* Touch target size for mobile */
  }

  :global(.dark) .form-input,
  :global(.dark) .form-select,
  :global(.dark) .form-textarea {
    color: rgb(243, 244, 246);
    background-color: rgba(31, 41, 55, 0.6);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .form-input::placeholder,
  .form-textarea::placeholder {
    color: rgb(156, 163, 175);
    opacity: 0.7;
  }

  :global(.dark) .form-input::placeholder,
  :global(.dark) .form-textarea::placeholder {
    color: rgb(107, 114, 128);
  }

  @media (hover: hover) and (pointer: fine) {
    .form-input:hover,
    .form-select:hover,
    .form-textarea:hover {
      border-color: rgba(59, 130, 246, 0.3);
      transform: translateY(-1px);
    }

    :global(.dark) .form-input:hover,
    :global(.dark) .form-select:hover,
    :global(.dark) .form-textarea:hover {
      border-color: rgba(96, 165, 250, 0.4);
    }
  }

  :global(.dark) .form-input:hover,
  :global(.dark) .form-select:hover,
  :global(.dark) .form-textarea:hover {
    border-color: rgba(96, 165, 250, 0.4);
  }

  .form-input:focus-visible,
  .form-select:focus-visible,
  .form-textarea:focus-visible {
    outline: none;
    border-color: rgb(59, 130, 246);
    box-shadow:
      0 0 0 3px rgba(59, 130, 246, 0.1),
      0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transform: translateY(-1px);
  }

  :global(.dark) .form-input:focus-visible,
  :global(.dark) .form-select:focus-visible,
  :global(.dark) .form-textarea:focus-visible {
    border-color: rgb(96, 165, 250);
    box-shadow:
      0 0 0 3px rgba(96, 165, 250, 0.15),
      0 4px 6px -1px rgba(0, 0, 0, 0.3);
  }

  .form-select {
    padding-right: 2.75rem;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25em;
    cursor: pointer;
  }

  :global(.dark) .form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  }

  :global(.dark) .form-select option {
    background-color: rgb(31, 41, 55);
    color: rgb(243, 244, 246);
  }

  .form-textarea {
    resize: none;
    min-height: clamp(100px, 20vw, 140px);
    padding-bottom: 2.5rem; /* Space for character counter */
  }

  .textarea-wrapper {
    position: relative;
  }

  .char-counter {
    position: absolute;
    bottom: clamp(0.5rem, 1.5vw, 0.75rem);
    right: clamp(0.625rem, 2vw, 0.875rem);
    font-size: clamp(0.6875rem, 1.5vw, 0.75rem);
    color: rgb(107, 114, 128);
    background: rgba(255, 255, 255, 0.95);
    padding: clamp(0.1875rem, 0.5vw, 0.25rem) clamp(0.375rem, 1vw, 0.5rem);
    border-radius: clamp(0.25rem, 0.75vw, 0.375rem);
    backdrop-filter: blur(8px);
    pointer-events: none;
    font-weight: 500;
  }

  :global(.dark) .char-counter {
    color: rgb(156, 163, 175);
    background: rgba(31, 41, 55, 0.9);
  }

  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: clamp(1.25rem, 3vw, 2rem);
  }

  .consent-row {
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    font-size: 0.875rem;
    color: rgb(75, 85, 99);
  }

  .consent-row input {
    margin-top: 0.15rem;
  }

  :global(.dark) .consent-row {
    color: rgb(156, 163, 175);
  }

  .submit-button {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: clamp(0.875rem, 2vw, 1rem) clamp(2rem, 5vw, 2.5rem);
    font-size: clamp(0.9375rem, 2vw, 1rem);
    font-weight: 600;
    color: white;
    background: linear-gradient(135deg, rgb(59, 130, 246) 0%, rgb(37, 99, 235) 100%);
    border: none;
    border-radius: clamp(0.5rem, 1.5vw, 0.75rem);
    cursor: pointer;
    overflow: hidden;
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease,
      background 0.2s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    min-height: 48px; /* Touch target size for mobile */
    min-width: 120px;
  }

  :global(.dark) .submit-button {
    background: linear-gradient(135deg, rgb(59, 130, 246) 0%, rgb(37, 99, 235) 100%);
    box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
  }

  .submit-button::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgb(37, 99, 235) 0%, rgb(29, 78, 216) 100%);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  @media (hover: hover) and (pointer: fine) {
    .submit-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow:
        0 10px 15px -3px rgba(59, 130, 246, 0.3),
        0 4px 6px -2px rgba(59, 130, 246, 0.2);
    }

    :global(.dark) .submit-button:hover:not(:disabled) {
      box-shadow:
        0 10px 15px -3px rgba(59, 130, 246, 0.4),
        0 4px 6px -2px rgba(59, 130, 246, 0.3);
    }

    .submit-button:hover:not(:disabled)::before {
      opacity: 1;
    }

    .submit-button:hover:not(:disabled) .button-icon {
      transform: translateX(4px);
    }
  }

  .submit-button:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-button:focus-visible {
    outline: none;
    box-shadow:
      0 0 0 3px rgba(59, 130, 246, 0.3),
      0 10px 15px -3px rgba(59, 130, 246, 0.3),
      0 4px 6px -2px rgba(59, 130, 246, 0.2);
  }

  .submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .button-content,
  .button-loading {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1;
  }

  .button-loading {
    display: none;
  }

  .submit-button[aria-busy="true"] .button-content {
    display: none;
  }

  .submit-button[aria-busy="true"] .button-loading {
    display: inline-flex;
  }

  .button-icon {
    width: clamp(1rem, 2.5vw, 1.25rem);
    height: clamp(1rem, 2.5vw, 1.25rem);
    transition: transform 0.3s ease;
    flex-shrink: 0;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Grid adjustments for different screen sizes */
  @media (max-width: 640px) {
    .contact-form-container {
      padding: 1.5rem 1rem;
      border-radius: 1rem;
    }

    .form-content {
      gap: 1.5rem;
    }

    .form-grid {
      gap: 1.5rem;
    }

    .form-field {
      gap: 0.5rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 16px; /* Prevent zoom on iOS */
      padding: 0.75rem 1rem;
      min-height: 48px; /* Larger touch target */
    }

    .form-textarea {
      min-height: 120px;
      padding-bottom: 2.75rem;
    }

    .char-counter {
      bottom: 0.625rem;
      right: 0.75rem;
      font-size: 0.6875rem;
      padding: 0.1875rem 0.375rem;
    }

    .submit-button {
      width: 100%;
      padding: 0.875rem 1.5rem;
      min-height: 48px;
      font-size: 1rem;
    }

    .button-icon {
      width: 1.125rem;
      height: 1.125rem;
    }
  }

  /* Tablet optimizations */
  @media (min-width: 641px) and (max-width: 1024px) {
    .contact-form-container {
      padding: 2.25rem 2rem;
    }

    .form-content {
      gap: 1.75rem;
    }

    .form-grid {
      gap: 1.75rem;
    }

    .form-field {
      gap: 0.5rem;
    }

    .submit-button {
      padding: 0.9375rem 2.25rem;
    }
  }

  /* Desktop optimizations */
  @media (min-width: 1025px) {
    .contact-form-container {
      padding: 3rem;
    }

    .form-content {
      gap: 2rem;
    }

    .form-grid {
      gap: 2rem;
    }

    .form-field {
      gap: 0.625rem;
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 0.875rem 1.125rem;
    }

    .submit-button {
      padding: 1rem 2.5rem;
    }
  }

  /* Large desktop */
  @media (min-width: 1440px) {
    .contact-form-container {
      padding: 3.5rem;
    }

    .form-content {
      gap: 2.25rem;
    }

    .form-grid {
      gap: 2.25rem;
    }
  }

  /* iOS specific fixes */
  @supports (-webkit-touch-callout: none) {
    .form-input,
    .form-select,
    .form-textarea {
      -webkit-appearance: none;
      transform: translateZ(0);
    }

    /* Prevent iOS zoom on focus */
    @media (max-width: 640px) {
      .form-input,
      .form-select,
      .form-textarea {
        font-size: 16px !important;
      }
    }
  }

  /* Touch device optimizations */
  @media (pointer: coarse) {
    .form-input,
    .form-select,
    .form-textarea {
      min-height: 48px;
    }

    .submit-button {
      min-height: 48px;
      min-width: 140px;
    }
  }
</style>

<script>
  import { toast, setDefaultTimeout } from "webcoreui";

  setDefaultTimeout(5000);

  type FormLang = "es" | "en";

  const COPY = {
    es: {
      errorTitle: "Error",
      sendFailed: "No se pudo enviar el mensaje.",
      validationError: "Revisa los datos del formulario.",
      validationReason: "Hay campos obligatorios vacíos o con formato incorrecto.",
      invalidName: "El nombre debe tener al menos 2 caracteres.",
      invalidEmail: "Introduce un email válido.",
      invalidMessage: "El mensaje debe tener entre 10 y 500 caracteres.",
      networkReason: "Error de red o del servidor.",
      statusReason: "Respuesta del servidor:",
    },
    en: {
      errorTitle: "Error",
      sendFailed: "Failed to send message.",
      validationError: "Please review the form fields.",
      validationReason: "Some required fields are missing or invalid.",
      invalidName: "Name must have at least 2 characters.",
      invalidEmail: "Please enter a valid email.",
      invalidMessage: "Message must be between 10 and 500 characters.",
      networkReason: "Network or server error.",
      statusReason: "Server response:",
    },
  } as const;

  const getLang = (value: string | undefined): FormLang => (value === "es" ? "es" : "en");
  const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

  const showErrorToast = (lang: FormLang, errorText: string, reasonText?: string, title?: string) => {
    const content = reasonText ? `${errorText} ${reasonText}` : errorText;
    toast({
      element: ".toast-error",
      title: title || COPY[lang].errorTitle,
      content,
      position: "bottom-full",
    });
  };

  const initContactForm = () => {
    const form = document.getElementById("contact-form") as HTMLFormElement | null;
    if (!form || form.dataset.contactInitialized === "true") return;
    form.dataset.contactInitialized = "true";

    const formLang = getLang(form.dataset.lang);
    const copy = COPY[formLang];
    const submitButton = form.querySelector(".submit-button") as HTMLButtonElement | null;
    const startedAtInput = form.querySelector("#form_started_at") as HTMLInputElement | null;
    const messageTextarea = form.querySelector("#message") as HTMLTextAreaElement | null;
    const charCount = form.querySelector("#charCount") as HTMLSpanElement | null;

    const syncCharCounter = () => {
      if (!charCount || !messageTextarea) return;
      charCount.textContent = messageTextarea.value.length.toString();
    };

    if (startedAtInput) {
      startedAtInput.value = Date.now().toString();
    }
    syncCharCounter();
    messageTextarea?.addEventListener("input", syncCharCounter);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const currentForm = e.currentTarget as HTMLFormElement;
      if (!currentForm.checkValidity()) {
        showErrorToast(formLang, copy.validationError, copy.validationReason, copy.errorTitle);
        currentForm.reportValidity();
        return;
      }

      const nameInput = currentForm.querySelector("#name") as HTMLInputElement | null;
      const emailInput = currentForm.querySelector("#email") as HTMLInputElement | null;
      const messageInput = currentForm.querySelector("#message") as HTMLTextAreaElement | null;
      const messageLength = messageInput?.value.trim().length ?? 0;

      if ((nameInput?.value.trim().length ?? 0) < 2) {
        showErrorToast(formLang, copy.validationError, copy.invalidName, copy.errorTitle);
        nameInput?.focus();
        return;
      }

      if (!isValidEmail(emailInput?.value.trim() || "")) {
        showErrorToast(formLang, copy.validationError, copy.invalidEmail, copy.errorTitle);
        emailInput?.focus();
        return;
      }

      if (messageLength < 10 || messageLength > 500) {
        showErrorToast(formLang, copy.validationError, copy.invalidMessage, copy.errorTitle);
        messageInput?.focus();
        return;
      }

      if (!submitButton) return;
      submitButton.setAttribute("disabled", "true");
      submitButton.setAttribute("aria-busy", "true");

      try {
        const response = await fetch("/api/contact", {
          method: "POST",
          body: new FormData(currentForm),
        });

        let result: {
          success: boolean;
          message?: string;
          error?: string;
          reason?: string;
          title?: string;
        } | null = null;

        try {
          result = await response.json();
        } catch (jsonError) {
          console.error("Failed to parse JSON response:", jsonError);
        }

        if (response.ok && result?.success) {
          toast({
            element: ".toast-success",
            title: result.title,
            content: result.message,
            position: "bottom-full",
          });
          currentForm.reset();
          syncCharCounter();
          if (startedAtInput) startedAtInput.value = Date.now().toString();
          return;
        }

        const fallbackReason = response.ok ? undefined : `${copy.statusReason} ${response.status}`;
        showErrorToast(
          formLang,
          result?.error || copy.sendFailed,
          result?.reason || fallbackReason,
          result?.title || copy.errorTitle
        );
      } catch (error) {
        const reason = error instanceof Error && error.message ? error.message : copy.networkReason;
        showErrorToast(formLang, copy.sendFailed, `${copy.networkReason} ${reason}`, copy.errorTitle);
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.removeAttribute("aria-busy");
      }
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContactForm, { once: true });
  } else {
    initContactForm();
  }

  // Keep form behavior stable when Astro client-side page transitions are enabled.
  document.addEventListener("astro:page-load", initContactForm);
  document.addEventListener("astro:after-swap", initContactForm);
</script>
